---
title: "Population identification with microarray signatures matching"
authors: Corentin Bernou, Alexandra Chicheportiche, LÃ©a Bellenger
output:
  html_document:
    df_print: paged
---

In this script, we load the population signatures defined using our microarrays experiments
We then select the top genes for each signature, and calculate a UCell score for each signature in each cell.
Cells are individually attributed to populations based on the highest score amongst signatures.

Libraries
```{r}
library(readr)
library(Seurat)
library(dplyr)
library(UCell)
library(ggplot2)
```

Loading signatures (Supp. Material #) and required objects
```{r}
list.files(path = "Microarray_signatures")
names_sig <- c("qNSC", "aNSC", "TAP", "iNB", "mNB")


Population_signatures <- lapply(X = paste0("Microarray_signatures/", #Use list_files again
                                 names_sig, 
                                 "_signature.csv"),
                      FUN = read_csv)

SCT_obj <- readRDS("SCT_obj.rds")
Biomart_annotated <- read.csv("Biomart_annotated.csv")

#Ajouter kable(head()) des signatures
```

This analysis is focused on NPC populations, therefore we will use a subset of the bas object
```{r}
Idents(SCT_obj) <- "clusters"
clusters_of_NPC <- c("4", "13", "17","20","12", "15", "19","5",
                                  "8", "10","1", "3", "7","9")

NPC_obj <- subset(SCT_obj, clusters %in% clusters_of_NPC) #Regarder avec les idents = cluster_of_NPC
rm(SCT_obj)
```


Selection of genes present in SCT assay and determination of top 100 based on FC
```{r}
Population_signatures <- 
  lapply(X = 1:length(names_sig),
         FUN = function(signature_nb){
           signature_list <- merge(x = Population_signatures[[signature_nb]],
                                          y = Biomart_annotated,
                                          by.x = "gene",
                                          by.y = "external_gene_name",
                                          all.x = TRUE) %>%
             filter( !is.na(description)) %>% # Use subset and select
             arrange(desc(FC))
           signature_list$...1 <- NULL
           signature_list$Population <- names_sig[[signature_nb]]
           signature_list <- filter(signature_list, ensembl_gene_id %in%
                                      rownames(NPC_obj@assays[["SCT"]]@data)) %>%
             arrange(desc(FC))
           write.csv(signature_list[1:100,], row.names = FALSE,
                     file = paste0("Outputs/Population_signatures_top100/Top100_", 
                                   names_sig[[signature_nb]], 
                                   "_signature.csv")) #Returns the gene list for verification
           return(signature_list[1:100,"ensembl_gene_id"])
         })

names_sig2 <- paste0("s_", names_sig)
names(Population_signatures) <- names_sig2
```

```{r}
method_UC <- "_UC_SCT"

DefaultAssay(NPC_obj) <- "SCT"

NPC_obj <-
  AddModuleScore_UCell(
    obj = NPC_obj,
    features = Population_signatures,
    name = method_UC,
    assay = "SCT")
```

Retrieve UCell scores and ID from object, then assign cell to population based on highest score
```{r}
# UCell_scores <- FetchData(NPC_obj, vars = c("id",paste0(names_sig2, method_UC)))
# colnames(UCell_scores) <- c("id",names_sig2)

VlnPlot(
  NPC_obj,
  features = paste0(names_sig2, method_UC),
  stack = TRUE,
  flip = TRUE
)


NPC_obj$Identity <- 
  colnames(NPC_obj@meta.data[,
                             paste0(names_sig2, method_UC)])[
                               
                     apply(NPC_obj@meta.data[,
                                             paste0(names_sig2,
                                                    method_UC)], 
                           1,
                           function(vec) {which(vec == max(vec))})
                     ]

Cell_identity <- UCell_scores$Identity
names(Cell_identity) <- rownames(UCell_scores)

NPC_obj <- AddMetaData(NPC_obj, metadata = Cell_identity, col.name = "Identity")

NPC_obj$Identity <- factor(NPC_obj$Identity, levels = names_sig2)
Idents(NPC_obj) <- "Identity"
```

Representing NPC cells only with identity

```{r}
theme_NPC <- list(scale_x_continuous(limits = c(-3.5,9)), #focus the umap
                  scale_y_continuous(limits = c(-15,5)),
                  NoLegend(),
                  NoAxes())

colors_identity <- c("#08D1E1", "#41ED58", "#369DE3", "#AE77EF", "#F4576F")

UMAPPlot(NPC_obj, label = T, cols = colors_identity, label.size = 5, repel = T) +
  theme_NPC
```


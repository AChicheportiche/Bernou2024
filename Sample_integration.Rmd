---
title: "Sample integration using SCT workflow"
authors: Corentin Bernou, Alexandra Chicheportiche, LÃ©a Bellenger
output:
  html_document:
    df_print: paged
---

In this script, we use the SCTransform workflow (Seurat v4) to integrate all samples together.

```{r}
library(tidyverse)
library(dplyr)
library(Seurat)
```

Loading object list
```{r}
Sample_list <- readRDS("Objects/Sample_list_after_subset.rds")
Biomart_annotated <- read.csv("Analysis_tools/Biomart_annotated.csv")
```

Prepare integration using SCTransform function (For workflow tutorial see https://satijalab.org/seurat/articles/sctransform_v2_vignette.html).
In this analysis, we used 4000 variable features and 10000 cells to normalize UMIs
We also used 4000 variables for integration

```{r}
Sample_list <- lapply(X = Sample_list, 
                   FUN = SCTransform,
                   variable.features.n = 4000,
                   return.only.var.genes = F)
```

We can then proceed to finding integration features based on the 4000 variable features, 
and carry on with the standard SCT integration workflow
Note that this results in an integrated assay, but that differential expression 
analysis will require an additional normalization step, using the PrepSCTIntegration function.
```{r}
Integration_Features <- SelectIntegrationFeatures(object.list = Sample_list, 
                                                  nfeatures = 4000,
                                                  assay = rep("SCT",4))

Sample_list <- PrepSCTIntegration(object.list = Sample_list,
                               anchor.features = Integration_Features)

Sample_list <- 
  FindIntegrationAnchors(Sample_list, normalization.method = "SCT",
                         anchor.features = Integration_Features)

SCT_obj <- IntegrateData(anchorset = Sample_list, normalization.method = "SCT")

saveRDS(object = SCT_obj, file = "Objects/SCT_obj.rds")
```
